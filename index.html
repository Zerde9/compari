<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ–∞—Ç—Ä–∞–ª—å–Ω—ã–π –ª–∏—Å—Ç–æ–∫: –ê.–ü. –ß–µ—Ö–æ–≤ –∏ —Å–æ—é–∑ –ö–ê–ö</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Marck+Script&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Old+Standard+TT:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, getDocs, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // –≠–∫—Å–ø–æ—Ä—Ç –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π –∏–ª–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤
        window.db = db;
        window.appId = appId;
        window.auth = auth;
        window.firestoreUtils = { collection, getDocs, query, setDoc, doc, serverTimestamp };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–∞–º–∏ (–ü—Ä–∞–≤–∏–ª–æ 3)
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };
        initAuth().catch(console.error);
    </script>

    <style>
        :root {
            --vintage-paper: #f4eee1;
            --theatre-red: #800000;
            --gold: #c5a059;
            --ink: #2c2c2c;
        }

        body {
            background-color: #1a1a1a;
            font-family: 'Old Standard TT', serif;
            color: var(--ink);
            overflow-x: hidden;
        }

        .parallax-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://images.unsplash.com/photo-1507676184212-d03ab07a01bf?auto=format&fit=crop&q=80&w=2000');
            background-attachment: fixed;
            background-position: bottom center;
            background-size: cover;
            opacity: 0.15;
            z-index: -1;
        }

        .paper-texture {
            background-color: var(--vintage-paper);
            background-image: url('https://www.transparenttextures.com/patterns/parchment.png');
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        .theatre-frame {
            border: 10px double var(--gold);
            padding: 2rem;
            position: relative;
        }

        .cursive { font-family: 'Marck Script', cursive; }
        .title-gold { color: var(--theatre-red); text-shadow: 1px 1px 0px var(--gold); }

        input[type="text"], input[type="password"], textarea {
            background: transparent;
            border-bottom: 1px dashed var(--theatre-red);
            outline: none;
            color: var(--theatre-red);
            font-weight: bold;
        }

        .comma-input { width: 30px; text-align: center; border-radius: 4px; transition: 0.3s; }
        .correct { background-color: #dcfce7 !important; border-color: #22c55e !important; }
        .incorrect { background-color: #fee2e2 !important; border-color: #ef4444 !important; }

        .btn-theatre {
            background: var(--theatre-red);
            color: var(--gold);
            border: 1px solid var(--gold);
            padding: 0.6rem 1.5rem;
            font-family: 'Playfair Display', serif;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: 0.3s;
            font-size: 0.9rem;
        }

        .btn-theatre:hover { background: var(--gold); color: var(--theatre-red); }

        .theory-block {
            border: 2px solid var(--gold);
            background: rgba(197, 160, 89, 0.1);
            position: relative;
            padding: 2rem;
            margin: 3rem 0;
        }

        .theory-block::after {
            content: '–ê–ù–¢–†–ê–ö–¢–™: –¢–ï–û–†–ò–Ø';
            position: absolute;
            top: -15px; left: 50%;
            transform: translateX(-50%);
            background: var(--gold);
            color: white;
            padding: 2px 20px;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .matching-item {
            cursor: pointer;
            border: 1px solid var(--gold);
            padding: 10px;
            margin: 5px 0;
            background: rgba(255,255,255,0.5);
        }

        .matching-item.selected { background: var(--theatre-red); color: var(--gold); }

        .hidden { display: none !important; }

        .theatre-footer {
            height: 300px;
            background-image: linear-gradient(to top, #1a1a1a, transparent), url('https://images.unsplash.com/photo-1503095396549-8070f9017609?auto=format&fit=crop&q=80&w=1500');
            background-size: cover;
            background-position: bottom;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .shake { animation: shake 0.2s ease-in-out 0s 2; }

        .modal-overlay {
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="py-12 px-4">
    <div class="parallax-bg"></div>

    <!-- –≠–ö–†–ê–ù –í–•–û–î–ê –£–ß–ï–ù–ò–ö–ê -->
    <div id="login-screen" class="fixed inset-0 z-[200] flex items-center justify-center p-4 modal-overlay">
        <div class="max-w-md w-full paper-texture theatre-frame text-center p-8">
            <h2 class="text-3xl font-bold title-gold mb-6 uppercase">–¢–µ–∞—Ç—Ä–∞–ª—å–Ω–∞—è –ö–∞—Å—Å–∞</h2>
            <p class="italic mb-8">–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ—Å—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Ö–æ–¥–Ω–æ–≥–æ –±–∏–ª–µ—Ç–∞</p>
            <div class="space-y-6">
                <div>
                    <label class="block text-xs uppercase mb-1 text-gray-500">–§–∞–º–∏–ª–∏—è</label>
                    <input type="text" id="user-lastname" class="w-full text-center text-xl p-2 border-b-2" required>
                </div>
                <div>
                    <label class="block text-xs uppercase mb-1 text-gray-500">–ò–º—è</label>
                    <input type="text" id="user-firstname" class="w-full text-center text-xl p-2 border-b-2" required>
                </div>
                <div>
                    <label class="block text-xs uppercase mb-1 text-gray-500">–ö–ª–∞—Å—Å</label>
                    <input type="text" id="user-grade" class="w-full text-center text-xl p-2 border-b-2" required>
                </div>
                <button onclick="startLesson()" class="btn-theatre w-full mt-4 text-xl py-4">–ü–æ–ª—É—á–∏—Ç—å –±–∏–ª–µ—Ç</button>
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ü–ê–†–û–õ–Ø –£–ß–ò–¢–ï–õ–Ø -->
    <div id="teacher-auth-modal" class="fixed inset-0 z-[400] flex items-center justify-center p-4 modal-overlay hidden">
        <div class="max-w-sm w-full paper-texture theatre-frame text-center p-8 border-4">
            <h2 class="text-2xl font-bold title-gold mb-4 uppercase">–î–æ—Å—Ç—É–ø—ä –≤ –ê—Ä—Ö–∏–≤—ä</h2>
            <p class="text-sm italic mb-6">–í–≤–µ–¥–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —à–∏—Ñ—Ä –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏</p>
            <input type="password" id="teacher-password-input" class="w-full text-center text-2xl p-2 border-b-2 mb-6" placeholder="****">
            <div class="flex gap-2">
                <button onclick="closeTeacherAuth()" class="btn-theatre bg-gray-500 border-gray-500 flex-1">–û—Ç–º–µ–Ω–∞</button>
                <button onclick="verifyTeacherPassword()" class="btn-theatre flex-1">–í–æ–π—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ -->
    <div id="main-content" class="max-w-4xl mx-auto paper-texture theatre-frame mb-20 hidden">
        
        <header class="text-center mb-12 border-b-4 border-double border-red-900 pb-8">
            <h2 class="text-xl italic mb-2 tracking-[0.2em] uppercase">–ò–º–ø–µ—Ä–∞—Ç–æ—Ä—Å–∫–∏–µ —Ç–µ–∞—Ç—Ä—ã –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç—ä</h2>
            <h1 class="text-5xl md:text-7xl font-bold title-gold mb-4 uppercase">–¢–µ–∞—Ç—Ä–∞–ª—å–Ω—ã–π –õ–∏—Å—Ç–æ–∫—ä</h1>
            <p class="text-2xl cursive mb-6">–ó–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è –ø—Ä–∏ —Å–æ—é–∑–µ ¬´–ö–ê–ö¬ª</p>
            <div class="flex justify-between items-center italic text-sm">
                <div id="display-name" class="border-b border-black px-4 font-bold">–ó—Ä–∏—Ç–µ–ª—å: ...</div>
                <div class="text-red-900 text-3xl">üé¶</div>
                <div id="display-grade" class="border-b border-black px-4 font-bold">–ö–ª–∞—Å—Å: ...</div>
            </div>
        </header>

        <!-- –ü—Ä–æ–ª–æ–≥ -->
        <section class="mb-16 grid md:grid-cols-3 gap-8 items-center">
            <div class="md:col-span-2">
                <h3 class="text-2xl font-bold text-red-900 mb-4 border-b border-gold inline-block uppercase">üìú –ü–†–û–õ–û–ì–™</h3>
                <p class="text-xl leading-relaxed italic">
                    –¢–µ–∞—Ç—Ä –ß–µ—Ö–æ–≤–∞ ‚Äî —ç—Ç–æ –∏—Å–∫—É—Å—Å—Ç–≤–æ –ø–æ–¥—Ç–µ–∫—Å—Ç–∞. –í –µ–≥–æ –ø—å–µ—Å–∞—Ö —Å–ª–æ–≤–∞ –∑–Ω–∞—á–∞—Ç –±–æ–ª—å—à–µ, —á–µ–º –∫–∞–∂–µ—Ç—Å—è –Ω–∞ –ø–µ—Ä–≤—ã–π –≤–∑–≥–ª—è–¥. 
                    –°–æ—é–∑ ¬´–∫–∞–∫¬ª —Ç–æ–∂–µ –∏–≥—Ä–∞–µ—Ç —Ä–∞–∑–Ω—ã–µ —Ä–æ–ª–∏. –†–∞—Å—Å—Ç–∞–≤—å—Ç–µ –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è –≤ –ø–µ—Ä–≤–æ–º –¥–µ–π—Å—Ç–≤–∏–∏.
                </p>
            </div>
            <div class="relative">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d1/Anton_Chekhov_1889.jpg/419px-Anton_Chekhov_1889.jpg" class="filter sepia border-2 border-white shadow-lg w-full rounded" alt="–ß–µ—Ö–æ–≤ 1889">
            </div>
        </section>

        <!-- –î–ï–ô–°–¢–í–ò–ï I -->
        <section class="mb-16" id="task1-section">
            <h3 class="text-2xl font-bold text-red-900 mb-6 flex items-center gap-4 uppercase">
                <span class="bg-red-900 text-white rounded-full w-10 h-10 flex items-center justify-center text-sm">I</span>
                –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞
            </h3>
            <div class="space-y-6 text-xl bg-white/40 p-6 rounded shadow-inner" id="task1">
                <p>1. –ß–µ—Ö–æ–≤ <input type="text" maxlength="1" class="comma-input" data-ans=""> –∫–∞–∫ –ø–∏—Å–∞—Ç–µ–ª—å –≤–æ—à—ë–ª –≤ –∏—Å—Ç–æ—Ä–∏—é –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã.</p>
                <p>2. –ß–µ—Ö–æ–≤ <input type="text" maxlength="1" class="comma-input" data-ans=","> –∫–∞–∫ —Ç–∞–ª–∞–Ω—Ç–ª–∏–≤—ã–π –¥—Ä–∞–º–∞—Ç—É—Ä–≥ <input type="text" maxlength="1" class="comma-input" data-ans=","> –∏–∑–º–µ–Ω–∏–ª —Ç–µ–∞—Ç—Ä.</p>
                <p>3. –¢–æ–ª—Å—Ç–æ–π –æ—Ç–∑—ã–≤–∞–ª—Å—è –æ –Ω—ë–º <input type="text" maxlength="1" class="comma-input" data-ans=""> –∫–∞–∫ –æ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ–º —á–µ–ª–æ–≤–µ–∫–µ.</p>
                <p>4. –ß–µ—Ö–æ–≤ <input type="text" maxlength="1" class="comma-input" data-ans=""> –∫–∞–∫ –≤—Ä–∞—á –ø–æ–Ω–∏–º–∞–ª —á–µ–ª–æ–≤–µ—á–µ—Å–∫—É—é –±–æ–ª—å.</p>
                <p>5. –ß–µ—Ö–æ–≤ <input type="text" maxlength="1" class="comma-input" data-ans=","> –∫–∞–∫ –∏—Å—Ç–∏–Ω–Ω—ã–π —Ö—É–¥–æ–∂–Ω–∏–∫ –∂–∏–∑–Ω–∏ <input type="text" maxlength="1" class="comma-input" data-ans=","> –≤–∏–¥–µ–ª —Ç—Ä–∞–≥–µ–¥–∏–∏.</p>
                <p>6. –ï–≥–æ —É–≤–∞–∂–∞–ª–∏ <input type="text" maxlength="1" class="comma-input" data-ans=""> –∫–∞–∫ –≤–µ–ª–∏–∫–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞ —Å–ª–æ–≤–∞.</p>
            </div>
            <div class="mt-4 flex justify-center">
                <button onclick="checkTask('task1')" class="btn-theatre">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–ø–ª–∏–∫–∏ I –¥–µ–π—Å—Ç–≤–∏—è</button>
            </div>
        </section>

        <!-- –¢–ï–û–†–ò–Ø -->
        <section class="theory-block shadow-lg">
            <h4 class="text-xl font-bold text-red-900 mb-4 uppercase text-center">üé≠ –¢–µ–∞—Ç—Ä–∞–ª—å–Ω—ã–π —Ä–∞–∑—ä–µ–∑–¥—ä: –ü—Ä–∞–≤–∏–ª–∞ —Å–æ—é–∑–∞ ¬´–ö–ê–ö¬ª</h4>
            <div class="grid md:grid-cols-2 gap-8 text-sm md:text-base italic">
                <div class="space-y-4">
                    <p class="bg-white p-3 border-l-4 border-red-900 shadow-sm">
                        <strong class="text-red-900 uppercase block mb-1">–ó–∞–ø—è—Ç–∞—è –ù–ï —Å—Ç–∞–≤–∏—Ç—Å—è:</strong>
                        –ï—Å–ª–∏ —Å–æ—é–∑ —Ä–∞–≤–µ–Ω –∑–Ω–∞—á–µ–Ω–∏—é <span class="font-bold">¬´–≤ –∫–∞—á–µ—Å—Ç–≤–µ¬ª</span>. 
                        <br><span class="text-gray-600 text-xs italic">–ü—Ä–∏–º–µ—Ä: –ß–µ—Ö–æ–≤ –∫–∞–∫ –≤—Ä–∞—á (=–≤ –∫–∞—á–µ—Å—Ç–≤–µ –≤—Ä–∞—á–∞) –ø–æ–Ω–∏–º–∞–ª –±–æ–ª—å.</span>
                    </p>
                </div>
                <div class="space-y-4">
                    <p class="bg-white p-3 border-l-4 border-gold shadow-sm">
                        <strong class="text-red-900 uppercase block mb-1">–ó–∞–ø—è—Ç–∞—è –°–¢–ê–í–ò–¢–°–Ø:</strong>
                        –ï—Å–ª–∏ –æ–±–æ—Ä–æ—Ç –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ <span class="font-bold">–ø—Ä–∏—á–∏–Ω—ã</span> (—Ç–∞–∫ –∫–∞–∫).
                        <br><span class="text-gray-600 text-xs italic">–ü—Ä–∏–º–µ—Ä: –ß–µ—Ö–æ–≤, –∫–∞–∫ —Ç–∞–ª–∞–Ω—Ç–ª–∏–≤—ã–π –≤—Ä–∞—á, –±—ã–ª –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω.</span>
                    </p>
                </div>
            </div>
        </section>

        <!-- –î–ï–ô–°–¢–í–ò–ï II -->
        <section class="mb-16">
            <h3 class="text-2xl font-bold text-red-900 mb-6 flex items-center gap-4 uppercase">
                <span class="bg-red-900 text-white rounded-full w-10 h-10 flex items-center justify-center text-sm">II</span>
                –ú–∏–∑–∞–Ω—Å—Ü–µ–Ω—ã
            </h3>
            <div class="space-y-6 text-xl bg-white/40 p-6 rounded shadow-inner" id="task2">
                <p>1. –ß–µ—Ö–æ–≤ <input type="text" maxlength="1" class="comma-input" data-ans=","> –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫ —Ä–µ–¥–∫–æ–π –¥—É—à–µ–≤–Ω–æ–π —Ç–æ–Ω–∫–æ—Å—Ç–∏ <input type="text" maxlength="1" class="comma-input" data-ans=","> –≤—Å–µ–≥–¥–∞ –æ—Å—Ç–∞–≤–∞–ª—Å—è —Å–∫—Ä–æ–º–Ω—ã–º.</p>
                <p>2. –ß–µ—Ö–æ–≤ <input type="text" maxlength="1" class="comma-input" data-ans=","> –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫, –≥–ª—É–±–æ–∫–æ –ø–µ—Ä–µ–∂–∏–≤–∞—é—â–∏–π –±–æ–ª—å <input type="text" maxlength="1" class="comma-input" data-ans=","> –Ω–µ –º–æ–≥ –±—ã—Ç—å —Ä–∞–≤–Ω–æ–¥—É—à–Ω—ã–º.</p>
                <p>3. –û–Ω <input type="text" maxlength="1" class="comma-input" data-ans=""> –∫–∞–∫ –≤—Ä–∞—á <input type="text" maxlength="1" class="comma-input" data-ans=","> –∞ –Ω–µ <input type="text" maxlength="1" class="comma-input" data-ans=""> –∫–∞–∫ –ø–∏—Å–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª—Å—è –Ω–∞ –°–∞—Ö–∞–ª–∏–Ω.</p>
            </div>
            <div class="mt-4 flex justify-center">
                <button onclick="checkTask('task2')" class="btn-theatre">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∏–∑–∞–Ω—Å—Ü–µ–Ω—ã II –¥–µ–π—Å—Ç–≤–∏—è</button>
            </div>
        </section>

        <!-- –õ–ê–ë–û–†–ê–¢–û–†–ò–Ø -->
        <section class="mb-16">
            <h3 class="text-2xl font-bold text-red-900 mb-6 text-center uppercase tracking-widest">üé® –¢–≤–æ—Ä—á–µ—Å–∫–∞—è –õ–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—è</h3>
            <div class="grid md:grid-cols-2 gap-8 border-y border-gold py-8 mb-8" id="matching-game">
                <div class="space-y-2" id="functions">
                    <div class="matching-item" data-id="1">–ó–Ω–∞—á–µ–Ω–∏–µ ¬´–≤ –∫–∞—á–µ—Å—Ç–≤–µ¬ª</div>
                    <div class="matching-item" data-id="2">–ó–Ω–∞—á–µ–Ω–∏–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</div>
                    <div class="matching-item" data-id="3">–ü—Ä–∏—á–∏–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</div>
                </div>
                <div class="space-y-2" id="examples">
                    <div class="matching-item" data-match="2">¬´–°—Ü–µ–Ω–∞ –∫–∞–∫ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä –º–µ–Ω—è–µ—Ç—Å—è¬ª</div>
                    <div class="matching-item" data-match="1">¬´–ú—ã –ø—Ä–∏–≥–ª–∞—Å–∏–ª–∏ –µ–≥–æ –∫–∞–∫ —ç–∫—Å–ø–µ—Ä—Ç–∞¬ª</div>
                    <div class="matching-item" data-match="3">¬´–ê–∫—Ç–µ—Ä, –∫–∞–∫ –º–∞—Å—Ç–µ—Ä, –ª–µ–≥–∫–æ –≤–æ—à–µ–ª –≤ —Ä–æ–ª—å¬ª</div>
                </div>
            </div>
            <div class="text-center mb-10">
                <button onclick="checkMatching()" id="check-match-btn" class="btn-theatre">–°–≤–µ—Ä–∏—Ç—å –º–∞—Å–∫–∏</button>
            </div>

            <div class="mb-8">
                <h4 class="text-xl font-bold text-red-900 mb-4 text-center uppercase">üìù –§–ò–ù–ê–õ–¨–ù–´–ô –ú–û–ù–û–õ–û–ì–™</h4>
                <textarea id="essay" class="w-full h-40 bg-white/60 border-2 border-gold p-4 text-xl cursive outline-none" placeholder="–ß–µ—Ö–æ–≤ —Å–µ–≥–æ–¥–Ω—è –∞–∫—Ç—É–∞–ª–µ–Ω —Ç–µ–º, —á—Ç–æ..."></textarea>
            </div>
        </section>

        <div class="text-center pb-12">
            <button onclick="finishLesson()" id="finish-btn" class="btn-theatre text-2xl px-12 py-5 shadow-2xl">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–ø–µ–∫—Ç–∞–∫–ª—å</button>
        </div>

        <footer class="mt-20 pt-8 border-t-2 border-gold flex justify-between items-center no-print">
            <button onclick="openTeacherAuthModal()" class="text-xs text-gray-500 hover:text-red-900 transition underline italic">–í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏</button>
            <p class="text-xs italic opacity-50">–ê–Ω—Ç–æ–Ω –ü–∞–≤–ª–æ–≤–∏—á –æ–¥–æ–±—Ä–∏–ª –±—ã –≤–∞—à–µ —Å—Ç–∞—Ä–∞–Ω–∏–µ.</p>
        </footer>
    </div>

    <!-- –¢–ê–ë–õ–ò–¶–ê –£–ß–ò–¢–ï–õ–Ø (–ê–†–•–ò–í) -->
    <div id="teacher-panel" class="fixed inset-0 z-[500] bg-white p-8 hidden overflow-y-auto">
        <div class="max-w-6xl mx-auto">
            <div class="flex justify-between items-center mb-8 border-b-2 border-gold pb-4">
                <h2 class="text-4xl font-bold title-gold uppercase">–¢–µ–∞—Ç—Ä–∞–ª—å–Ω—ã–π –ê—Ä—Ö–∏–≤—ä</h2>
                <button onclick="closeTeacherPanel()" class="btn-theatre">–ó–∞–∫—Ä—ã—Ç—å –∞—Ä—Ö–∏–≤</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse bg-white shadow-lg">
                    <thead class="bg-red-900 text-white uppercase text-xs">
                        <tr>
                            <th class="p-4 border">–í—Ä–µ–º—è</th>
                            <th class="p-4 border">–£—á–µ–Ω–∏–∫</th>
                            <th class="p-4 border">–ö–ª–∞—Å—Å</th>
                            <th class="p-4 border text-center">–ë–∞–ª–ª—ã</th>
                            <th class="p-4 border">–≠—Å—Å–µ</th>
                        </tr>
                    </thead>
                    <tbody id="results-table-body" class="text-sm"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="theatre-footer mt-[-50px] relative z-[-1]"></div>

    <script type="module">
        // –ü–µ—Ä–µ–Ω–æ—Å —Ñ—É–Ω–∫—Ü–∏–π –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è –∏–∑ onclick
        let userData = { ln: '', fn: '', gr: '' };
        let matchingState = { selectedId: null, correctCount: 0 };

        window.startLesson = function() {
            const ln = document.getElementById('user-lastname').value.trim();
            const fn = document.getElementById('user-firstname').value.trim();
            const gr = document.getElementById('user-grade').value.trim();
            if (!ln || !fn || !gr) return alert("–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ—Å—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞!");
            
            userData = { ln, fn, gr };
            document.getElementById('display-name').innerText = `–ó—Ä–∏—Ç–µ–ª—å: ${ln} ${fn}`;
            document.getElementById('display-grade').innerText = `–ö–ª–∞—Å—Å: ${gr}`;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            window.scrollTo(0,0);
        };

        window.checkTask = function(taskId) {
            const container = document.getElementById(taskId);
            const inputs = container.querySelectorAll('.comma-input');
            let taskScore = 0;
            inputs.forEach(input => {
                const ans = input.getAttribute('data-ans');
                const val = input.value.trim();
                input.classList.remove('correct', 'incorrect');
                if (val === ans) {
                    input.classList.add('correct');
                    taskScore++;
                } else {
                    input.classList.add('incorrect');
                }
            });
            return taskScore;
        };

        // Matching Logic
        document.querySelectorAll('.matching-item').forEach(item => {
            item.addEventListener('click', function() {
                const parent = this.parentElement.id;
                if (parent === 'functions') {
                    document.querySelectorAll('#functions .matching-item').forEach(i => i.classList.remove('selected'));
                    this.classList.add('selected');
                    matchingState.selectedId = this.getAttribute('data-id');
                } else if (parent === 'examples' && matchingState.selectedId) {
                    if (this.getAttribute('data-match') === matchingState.selectedId) {
                        this.style.backgroundColor = '#c5a059';
                        this.style.color = '#fff';
                        document.querySelector(`#functions [data-id="${matchingState.selectedId}"]`).style.opacity = '0.3';
                        document.querySelector(`#functions [data-id="${matchingState.selectedId}"]`).style.pointerEvents = 'none';
                        matchingState.correctCount++;
                        matchingState.selectedId = null;
                    } else {
                        this.classList.add('shake');
                        setTimeout(() => this.classList.remove('shake'), 500);
                    }
                }
            });
        });

        window.checkMatching = function() {
            if (matchingState.correctCount === 3) {
                alert("–í—Å–µ –º–∞—Å–∫–∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –≤–µ—Ä–Ω–æ!");
            } else {
                alert(`–í–µ—Ä–Ω–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–æ: ${matchingState.correctCount} –∏–∑ 3. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –ø–æ–∏—Å–∫.`);
            }
        };

        window.finishLesson = async function() {
            const score1 = window.checkTask('task1');
            const score2 = window.checkTask('task2');
            const totalScore = score1 + score2 + matchingState.correctCount;

            const btn = document.getElementById('finish-btn');
            btn.disabled = true;
            btn.innerText = "–†–∞–±–æ—Ç–∞ –≤ –∞—Ä—Ö–∏–≤–µ...";

            const { setDoc, doc, serverTimestamp } = window.firestoreUtils;

            const data = {
                student: `${userData.ln} ${userData.fn}`,
                grade: userData.gr,
                score: totalScore,
                essay: document.getElementById('essay').value,
                timestamp: serverTimestamp(),
                createdAt: new Date().toLocaleString('ru-RU')
            };

            try {
                const resultDoc = doc(window.db, 'artifacts', window.appId, 'public', 'data', 'responses', `${Date.now()}_${userData.ln}`);
                await setDoc(resultDoc, data);
                showFinalFeedback(totalScore);
            } catch (e) {
                console.error(e);
                btn.disabled = false;
                btn.innerText = "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É";
                alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.");
            }
        };

        function showFinalFeedback(score) {
            const m = document.createElement('div');
            m.className = "fixed inset-0 flex items-center justify-center bg-black/95 z-[600] p-4";
            m.innerHTML = `
                <div class="paper-texture theatre-frame p-12 text-center max-w-lg shadow-2xl">
                    <h2 class="text-5xl title-gold mb-6 uppercase">–ó–ê–ù–ê–í–ï–°!</h2>
                    <p class="text-2xl italic mb-8">–ë–ª–∞–≥–æ–¥–∞—Ä–∏–º –∑–∞ —É—á–∞—Å—Ç–∏–µ –≤ –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–µ.</p>
                    <div class="text-7xl font-bold text-red-900 mb-8 border-y-2 border-gold py-4">${score} / 16</div>
                    <button onclick="location.reload()" class="btn-theatre text-xl">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∫–∞—Å—Å—É</button>
                </div>
            `;
            document.body.appendChild(m);
        }

        window.openTeacherAuthModal = function() {
            document.getElementById('teacher-auth-modal').classList.remove('hidden');
            document.getElementById('teacher-password-input').focus();
        };

        window.closeTeacherAuth = function() {
            document.getElementById('teacher-auth-modal').classList.add('hidden');
            document.getElementById('teacher-password-input').value = '';
        };

        window.verifyTeacherPassword = function() {
            const pass = document.getElementById('teacher-password-input').value;
            if (pass === 'JA123') {
                window.closeTeacherAuth();
                window.openArchive();
            } else {
                alert("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞.");
                document.getElementById('teacher-password-input').value = '';
            }
        };

        window.openArchive = async function() {
            document.getElementById('teacher-panel').classList.remove('hidden');
            const tbody = document.getElementById('results-table-body');
            tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center italic">–ü–æ–∏—Å–∫ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º...</td></tr>';
            
            const { collection, getDocs, query } = window.firestoreUtils;

            try {
                const q = query(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'responses'));
                const snap = await getDocs(q);
                let html = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    html += `
                        <tr class="hover:bg-red-50 border-b">
                            <td class="p-4 border">${d.createdAt || '‚Äî'}</td>
                            <td class="p-4 border font-bold text-red-900">${d.student}</td>
                            <td class="p-4 border">${d.grade}</td>
                            <td class="p-4 border text-center font-bold text-lg">${d.score}</td>
                            <td class="p-4 border text-xs italic bg-gray-50">${d.essay?.substring(0,150) || '...'}...</td>
                        </tr>
                    `;
                });
                tbody.innerHTML = html || '<tr><td colspan="5" class="p-8 text-center italic">–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç</td></tr>';
            } catch (e) { 
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="5" class="text-red-900 p-8 text-center">–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.</td></tr>'; 
            }
        };

        window.closeTeacherPanel = function() { document.getElementById('teacher-panel').classList.add('hidden'); };
    </script>
</body>
</html>